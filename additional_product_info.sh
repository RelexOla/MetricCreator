MESSAGES_INPUT="/opt/apps/processor-sok-kt-test/shared/data/messages/input/"
MESSAGES_INPUT_TEMP_FOLDER="${MESSAGES_INPUT}temp/"
SCRIPT_LOG="/opt/apps/processor-sok-kt-test/scripts/additional_product_info.log"
MESSAGES_PROCESSED="/opt/apps/processor-sok-kt-test/shared/data/messages/processed/"

date >> ${SCRIPT_LOG}
echo "Esillepanoryhma"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Esillepanoryhma_* &> /dev/null; then for i in ${MESSAGES_INPUT}Esillepanoryhma_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._esillepanoryhma_in; copy customer._esillepanoryhma_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._esillepanoryhma where code in (select code from customer._esillepanoryhma_in); insert into customer._esillepanoryhma select * from customer._esillepanoryhma_in;" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done else echo "No esillepanoryhma files"  >> ${SCRIPT_LOG} 
fi
echo "Tavararyhma"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Tavararyhma_* &> /dev/null;
then
for i in ${MESSAGES_INPUT}Tavararyhma_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._tavararyhma_in; copy customer._tavararyhma_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._tavararyhma where code in (select code from customer._tavararyhma_in); insert into customer._tavararyhma select * from customer._tavararyhma_in;" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done
else
echo "No tavararyhma files"  >> ${SCRIPT_LOG}
fi
echo "Ketjuvalikoima"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Ketjuvalikoima_* &> /dev/null;
then
for i in ${MESSAGES_INPUT}Ketjuvalikoima_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._ketjuvalikoima_in; copy customer._ketjuvalikoima_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._ketjuvalikoima using customer._ketjuvalikoima_in where _ketjuvalikoima.code=_ketjuvalikoima_in.code and _ketjuvalikoima.customer_ketjuvalikalkpvm=_ketjuvalikoima_in.customer_ketjuvalikalkpvm; insert into customer._ketjuvalikoima select code, customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm, customer_ketjuvalikoimaluokka from customer._ketjuvalikoima_in where customer_tila='5';" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done
else
echo "No ketjuvalikoima files"  >> ${SCRIPT_LOG}
fi
echo "Tilausvalikoima"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Tilausvalikoima_* &> /dev/null;
then
for i in ${MESSAGES_INPUT}Tilausvalikoima_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._tilausvalikoima_in; copy customer._tilausvalikoima_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._tilausvalikoima using customer._tilausvalikoima_in where _tilausvalikoima.product_code=_tilausvalikoima_in.product_code and _tilausvalikoima.outlet_code=_tilausvalikoima_in.outlet_code and (_tilausvalikoima_in.customer_tilausvalikoiman_alkupaiva=_tilausvalikoima.customer_tilausvalikoiman_alkupaiva or _tilausvalikoima_in.customer_tilausvalikoiman_alkupaiva is null or _tilausvalikoima_in.customer_tilausvalikoiman_loppupaiva=_tilausvalikoima.customer_tilausvalikoiman_loppupaiva); insert into customer._tilausvalikoima (product_code, outlet_code, customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva, customer_kertatoimitettava) select product_code, outlet_code, customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva, customer_kertatoimitettava from customer._tilausvalikoima_in where customer_poistunut is null;" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done
else
echo "No tilausvalikoima files"  >> ${SCRIPT_LOG}
fi
echo "Toimituspakkaus"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Toimituspakkaus_* &> /dev/null;
then
for i in ${MESSAGES_INPUT}Toimituspakkaus_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._toimituspakkaus_in; copy customer._toimituspakkaus_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._toimituspakkaus where code in (select code from customer._toimituspakkaus_in); insert into customer._toimituspakkaus select * from customer._toimituspakkaus_in;" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done
else
echo "No toimituspakkaus files"  >> ${SCRIPT_LOG}
fi
echo "Toimittaja"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Toimittaja_* &> /dev/null;
then
for i in ${MESSAGES_INPUT}Toimittaja_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._toimittaja_in; copy customer._toimittaja_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._toimittaja where upper(code) in (select upper(code) from customer._toimittaja_in); insert into customer._toimittaja select * from customer._toimittaja_in;" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done
else
echo "No toimitaja files"  >> ${SCRIPT_LOG}
fi
echo "Kaytettavatoimittaja"  >> ${SCRIPT_LOG}
if ls ${MESSAGES_INPUT}Kaytettavatoimittaja_* &> /dev/null;
then
for i in ${MESSAGES_INPUT}Kaytettavatoimittaja_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt-preprocess_production -c "truncate table customer._kaytettavatoimittaja_in; copy customer._kaytettavatoimittaja_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._kaytettavatoimittaja using customer._kaytettavatoimittaja_in where _kaytettavatoimittaja_in.location=_kaytettavatoimittaja.location and _kaytettavatoimittaja_in.product=_kaytettavatoimittaja.product and _kaytettavatoimittaja_in.customer_kaytettavatoimittaja_alkupvm=_kaytettavatoimittaja.customer_kaytettavatoimittaja_alkupvm; insert into customer._kaytettavatoimittaja select * from customer._kaytettavatoimittaja_in;" >> ${SCRIPT_LOG}; mv $i ${MESSAGES_PROCESSED}; done
else
echo "No kaytettavatoimittaja files"  >> ${SCRIPT_LOG}
fi
# Create Tilausvalikoima message
today=$(date +%Y-%m-%d)
psql processor-sok-kt-preprocess_production -c "drop table customer._tilausvalikoima_out;"
# Current tilausvalikoima
psql processor-sok-kt-preprocess_production -c "select t.* into customer._tilausvalikoima_out from customer._tilausvalikoima t, (select product_code, outlet_code, max(customer_tilausvalikoiman_alkupaiva) alkupv from customer._tilausvalikoima where current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between customer_tilausvalikoiman_alkupaiva and customer_tilausvalikoiman_loppupaiva group by product_code, outlet_code) sd where t.product_code=sd.product_code and t.outlet_code=sd.outlet_code and t.customer_tilausvalikoiman_alkupaiva=sd.alkupv;"
# Future tilausvalikoima
psql processor-sok-kt-preprocess_production -c "insert into customer._tilausvalikoima_out select t.* from customer._tilausvalikoima t left join customer._tilausvalikoima_out o on t.product_code=o.product_code and t.outlet_code=o.outlet_code, (select product_code, outlet_code, min(customer_tilausvalikoiman_alkupaiva) alkupv from customer._tilausvalikoima where current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end<customer_tilausvalikoiman_alkupaiva  group by product_code, outlet_code) sd where t.product_code=sd.product_code and t.outlet_code=sd.outlet_code and t.customer_tilausvalikoiman_alkupaiva=sd.alkupv and o.product_code is null;"
# Past tilausvalikoima
psql processor-sok-kt-preprocess_production -c "insert into customer._tilausvalikoima_out select t.* from customer._tilausvalikoima t left join customer._tilausvalikoima_out o on t.product_code=o.product_code and t.outlet_code=o.outlet_code, (select product_code, outlet_code, max(customer_tilausvalikoiman_alkupaiva) alkupv from customer._tilausvalikoima where current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end>customer_tilausvalikoiman_loppupaiva  group by product_code, outlet_code) sd where t.product_code=sd.product_code and t.outlet_code=sd.outlet_code and t.customer_tilausvalikoiman_alkupaiva=sd.alkupv and o.product_code is null;"
psql processor-sok-kt-preprocess_production -c "copy (select product_code product, outlet_code as location, customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva, customer_kertatoimitettava from customer._tilausvalikoima_out) to stdout with delimiter ';' csv header;" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Update_tilausvalikoima_$today.csv
# Create future tilausvalikoima message
psql processor-sok-kt-preprocess_production -c "copy (select t.product_code product, t.outlet_code as location, t.customer_tilausvalikoiman_alkupaiva customer_tulevan_tilausvalikoiman_alkupaiva, t.customer_tilausvalikoiman_loppupaiva customer_tulevan_tilausvalikoiman_loppupaiva from customer._tilausvalikoima t left join customer._tilausvalikoima_out o on t.product_code=o.product_code and t.outlet_code=o.outlet_code and t.customer_tilausvalikoiman_alkupaiva=o.customer_tilausvalikoiman_alkupaiva where o.product_code is null and t.customer_tilausvalikoiman_alkupaiva>current_date) to stdout with delimiter ';' csv header;" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Update_tuleva_tilausvalikoima_$today.csv
# Create previous Tilausvalikoima message
psql processor-sok-kt-preprocess_production -c "copy (select tv.product_code product, tv.outlet_code as location, customer_tilausvalikoiman_alkupaiva customer_edellisen_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva customer_edellisen_tilausvalikoiman_loppupaiva from customer._tilausvalikoima tv, (select product_code, outlet_code, max(customer_tilausvalikoiman_loppupaiva) max_pv from customer._tilausvalikoima where customer_tilausvalikoiman_loppupaiva<current_date+1 group by  product_code, outlet_code) tvmax where tv.product_code=tvmax.product_code and tv.outlet_code=tvmax.outlet_code and tv.customer_tilausvalikoiman_loppupaiva=tvmax.max_pv) to stdout with delimiter ';' csv header;" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Update_edellinen_tilausvalikoima_$today.csv
# Create general supplier message
echo "update_only" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Supplier_Update_kaytettavatoimittaja_no_outlet_code_$today.csv; psql processor-sok-kt-preprocess_production -c "copy (select product, upper(supplier) supplier from customer._kaytettavatoimittaja where current_date between customer_kaytettavatoimittaja_alkupvm and customer_kaytettavatoimittaja_loppupvm and \"location\"='0') to stdout WITH CSV HEADER DELIMITER ';';" >> ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Supplier_Update_kaytettavatoimittaja_no_outlet_code_$today.csv
# Create supplier message based on locations
echo "update_only" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Supplier_With_Location_Update_kaytettavatoimittaja_with_outlet_code_$today.csv; psql processor-sok-kt-preprocess_production -c "copy (select product, \"location\", upper(supplier) supplier from customer._kaytettavatoimittaja where current_date between customer_kaytettavatoimittaja_alkupvm and customer_kaytettavatoimittaja_loppupvm and \"location\"<>'0') to stdout WITH CSV HEADER DELIMITER ';';" >> ${MESSAGES_INPUT_TEMP_FOLDER}Product_Location_Supplier_With_Location_Update_kaytettavatoimittaja_with_outlet_code_$today.csv
# Update additional info from staging tables
# Create Esillepanoryhma output table. Transpose rows from input file to columns in output file
psql processor-sok-kt-preprocess_production -c "drop table customer._esillepanoryhma_out;"
psql processor-sok-kt-preprocess_production -c "select code customer_epr8_tunnus, name customer_epr8_nimi, parent customer_epr7_tunnus, cast(null as text) customer_epr7_nimi, cast(null as text) customer_epr6_tunnus, cast(null as text) customer_epr6_nimi, cast(null as text) customer_epr5_tunnus, cast(null as text) customer_epr5_nimi, cast(null as text) customer_epr4_tunnus, cast(null as text) customer_epr4_nimi, cast(null as text) customer_epr3_tunnus, cast(null as text) customer_epr3_nimi, cast(null as text) customer_epr2_tunnus, cast(null as text) customer_epr2_nimi, cast(null as text) customer_epr1_tunnus, cast(null as text) customer_epr1_nimi into customer._esillepanoryhma_out from customer._esillepanoryhma where taso='8';"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr7_nimi=name, customer_epr6_tunnus=parent from customer._esillepanoryhma where taso='7' and code=customer_epr7_tunnus;"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr6_nimi=name, customer_epr5_tunnus=parent from customer._esillepanoryhma where taso='6' and code=customer_epr6_tunnus;"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr5_nimi=name, customer_epr4_tunnus=parent from customer._esillepanoryhma where taso='5' and code=customer_epr5_tunnus;"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr4_nimi=name, customer_epr3_tunnus=parent from customer._esillepanoryhma where taso='4' and code=customer_epr4_tunnus;"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr3_nimi=name, customer_epr2_tunnus=parent from customer._esillepanoryhma where taso='3' and code=customer_epr3_tunnus;"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr2_nimi=name, customer_epr1_tunnus=parent from customer._esillepanoryhma where taso='2' and code=customer_epr2_tunnus;"
psql processor-sok-kt-preprocess_production -c "update customer._esillepanoryhma_out set customer_epr1_nimi=name from customer._esillepanoryhma where taso='1' and code=customer_epr1_tunnus;"
psql processor-sok-kt-preprocess_production -c "copy (select upper(customer_epr8_tunnus) \"code:products.customer_epr8_tunnus\", customer_epr8_nimi, upper(customer_epr7_tunnus) \"customer_epr7_tunnus\", upper(customer_epr7_tunnus) \"customer_epr7_tunnus_upcase\", customer_epr7_nimi, upper(customer_epr6_tunnus) \"customer_epr6_tunnus\", customer_epr6_nimi, upper(customer_epr5_tunnus) \"customer_epr5_tunnus\", customer_epr5_nimi, upper(customer_epr4_tunnus) \"customer_epr4_tunnus\", customer_epr4_nimi, upper(customer_epr3_tunnus) \"customer_epr3_tunnus\", customer_epr3_nimi, upper(customer_epr2_tunnus) \"customer_epr2_tunnus\", customer_epr2_nimi, upper(customer_epr1_tunnus) \"customer_epr1_tunnus\", customer_epr1_nimi from customer._esillepanoryhma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_EPR_$today.csv
# Create toimituspakkaus message
psql processor-sok-kt-preprocess_production -c "copy (select code, upper(tunnus_array[1]) as customer_toimpakk1tunnus, upper(tunnus_array[2]) as customer_toimpakk2tunnus, upper(tunnus_array[3]) as customer_toimpakk3tunnus, upper(tunnus_array[4]) as customer_toimpakk4tunnus, upper(tunnus_array[5]) as customer_toimpakk5tunnus, tyyppi_array[1] as customer_toimpakk1tyyppi, tyyppi_array[2] as customer_toimpakk2tyyppi, tyyppi_array[3] as customer_toimpakk3tyyppi, tyyppi_array[4] as customer_toimpakk4tyyppi, tyyppi_array[5] as customer_toimpakk5tyyppi, maara_array[1] as customer_toimpakk1maara, maara_array[2] as customer_toimpakk2maara, maara_array[3] as customer_toimpakk3maara, maara_array[4] as customer_toimpakk4maara, maara_array[5] as customer_toimpakk5maara from (select code,ui.array_accum(customer_toimpakktunnus) as tunnus_array, ui.array_accum(customer_toimpakktyyppi) as tyyppi_array, ui.array_accum(customer_toimpakkmaara) as maara_array from (select code, customer_toimpakktunnus, customer_toimpakktyyppi, customer_toimpakkmaara from customer._toimituspakkaus where current_date between customer_toimpakkalkpvm and customer_toimpakkloppvm and current_date between customer_toimpakkmalkpvm and customer_toimpakkmloppvm order by code, customer_toimpakkmaara asc) a group by a.code) b) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_toimituspakkaus_$today.csv
#Create future toimituspakkaus message
psql processor-sok-kt-preprocess_production -c "copy (SELECT code, upper(tunnus_array[1]) as customer_toimpakk1tunnus, upper(tunnus_array[2]) as customer_toimpakk2tunnus, upper(tunnus_array[3]) as customer_toimpakk3tunnus, upper(tunnus_array[4]) as customer_toimpakk4tunnus, upper(tunnus_array[5]) as customer_toimpakk5tunnus, tyyppi_array[1] as customer_toimpakk1tyyppi, tyyppi_array[2] as customer_toimpakk2tyyppi, tyyppi_array[3] as customer_toimpakk3tyyppi, tyyppi_array[4] as customer_toimpakk4tyyppi, tyyppi_array[5] as customer_toimpakk5tyyppi, maara_array[1] as customer_toimpakk1maara, maara_array[2] as customer_toimpakk2maara, maara_array[3] as customer_toimpakk3maara, maara_array[4] as customer_toimpakk4maara, maara_array[5] AS customer_toimpakk5maara FROM (SELECT code, ui.array_accum(customer_toimpakktunnus) AS tunnus_array, ui.array_accum(customer_toimpakktyyppi) AS tyyppi_array, ui.array_accum(customer_toimpakkmaara) AS maara_array FROM (SELECT code, customer_toimpakktunnus, customer_toimpakktyyppi, customer_toimpakkmaara FROM customer._toimituspakkaus WHERE CURRENT_DATE < customer_toimpakkalkpvm AND CURRENT_DATE < customer_toimpakkmalkpvm AND code NOT IN (SELECT code FROM customer._toimituspakkaus WHERE CURRENT_DATE BETWEEN customer_toimpakkalkpvm AND customer_toimpakkloppvm AND CURRENT_DATE BETWEEN customer_toimpakkmalkpvm AND customer_toimpakkmloppvm) ORDER BY code, customer_toimpakkmaara ASC) a GROUP BY a.code) b) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_future_toimituspakkaus_$today.csv
# Create manufacturer message
psql processor-sok-kt-preprocess_production -c "copy (select distinct upper(code) \"code:products.customer_valmistaja\", customer_ly customer_valmistaja_ly, customer_tilotunnus customer_valmistaja_tilotunnus, name customer_valmistaja_nimi from customer._toimittaja) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_valmistaja_$today.csv
# Create tavararyhma message
psql processor-sok-kt-preprocess_production -c "drop table customer._tavararyhma1;"
psql processor-sok-kt-preprocess_production -c "drop table customer._tavararyhma2;"
psql processor-sok-kt-preprocess_production -c "drop table customer._tavararyhma3;"
psql processor-sok-kt-preprocess_production -c "drop table customer._tavararyhma4;"
psql processor-sok-kt-preprocess_production -c "drop table customer._tavararyhma5;"
psql processor-sok-kt-preprocess_production -c "drop table customer._tavararyhma6;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tavararyhma1 from customer._tavararyhma where parent is null;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tavararyhma2 from customer._tavararyhma where parent in (select code from customer._tavararyhma1);"
psql processor-sok-kt-preprocess_production -c "select * into customer._tavararyhma3 from customer._tavararyhma where parent in (select code from customer._tavararyhma2);"
psql processor-sok-kt-preprocess_production -c "select * into customer._tavararyhma4 from customer._tavararyhma where parent in (select code from customer._tavararyhma3);"
psql processor-sok-kt-preprocess_production -c "select * into customer._tavararyhma5 from customer._tavararyhma where parent in (select code from customer._tavararyhma4);"
psql processor-sok-kt-preprocess_production -c "select * into customer._tavararyhma6 from customer._tavararyhma where parent in (select code from customer._tavararyhma5);"
psql processor-sok-kt-preprocess_production -c "copy (select upper(tr6.code) \"code:products.customer_tr6_tunniste\", tr6.tunnus customer_tr6_tunnus, tr6.name customer_tr6_nimi, tr5.code customer_tr5_tunniste, tr5.tunnus customer_tr5_tunnus, tr5.name customer_tr5_nimi, tr4.code customer_tr4_tunniste, tr4.tunnus customer_tr4_tunnus, tr4.name customer_tr4_nimi, tr3.code customer_tr3_tunniste, tr3.tunnus customer_tr3_tunnus, tr3.name customer_tr3_nimi, tr2.code customer_tr2_tunniste, tr2.tunnus customer_tr2_tunnus, tr2.name customer_tr2_nimi, tr1.code customer_tr1_tunniste, tr1.tunnus customer_tr1_tunnus, tr1.name customer_tr1_nimi from customer._tavararyhma6 tr6, customer._tavararyhma5 tr5, customer._tavararyhma4 tr4, customer._tavararyhma3 tr3, customer._tavararyhma2 tr2, customer._tavararyhma1 tr1 where tr6.parent=tr5.code and tr5.parent=tr4.code and tr4.parent=tr3.code and tr3.parent=tr2.code and tr2.parent=tr1.code) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tavararyhma_$today.csv

# Ketjuvalikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_terra_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_terra_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='T' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='T' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_terra_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='T' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='T' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_terra_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikalkpvm_terra:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikloppvm_terra:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_terra:erase_before\" from customer._ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_terra_$today.csv

# Tilausmyyntivalikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_terra_out;"
# Current Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_terra_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_terra_out);"
# Past Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='TA' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_terra_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tilausmyynti_tr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tilausmyynti_tr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tilausmyynti_tr_luokka:erase_before\" from customer._ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tilausmyynti_terra_$today.csv

# KT-vaihtuva valikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_terra_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_terra_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_terra_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='TE' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_terra_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_tr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_tr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_tr_luokka:erase_before\" from customer._ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_kt_vaihtuva_terra_$today.csv

# Lisävalikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_terra_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_terra_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_terra_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_terra_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='TL' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_terra_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_tr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_tr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_tr_luokka:erase_before\" from customer._ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_lisavalikoima_terra_$today.csv

# Ketjuvalikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_prisma_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_prisma_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='C' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='C' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_prisma_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='C' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='C' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_prisma_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikalkpvm_prisma:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikloppvm_prisma:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_prisma:erase_before\" from customer._ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_prisma_$today.csv

# Tilausmyyntivalikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_prisma_out;"
# Current Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_prisma_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_prisma_out);"
# Past Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='CA' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_prisma_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tilausmyynti_pr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tilausmyynti_pr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tilausmyynti_pr_luokka:erase_before\" from customer._ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tilausmyynti_prisma_$today.csv

# KT-vaihtuva valikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_prisma_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_prisma_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_prisma_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='CE' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_prisma_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_pr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_pr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_pr_luokka:erase_before\" from customer._ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_kt_vaihtuva_prisma_$today.csv

# Lisävalikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_prisma_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_prisma_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_prisma_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_prisma_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='CL' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_prisma_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_pr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_pr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_pr_luokka:erase_before\" from customer._ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_lisavalikoima_prisma_$today.csv

# Ketjuvalikoimaluokka M&S message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_marks_spencer_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_marks_spencer_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Z' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_marks_spencer_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Z' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_marks_spencer_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_marks_spencer_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Z' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='Z' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_marks_spencer_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikalkpvm_marks_spencer:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikloppvm_marks_spencer:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_marks_spencer:erase_before\" from customer._ketjuvalikoima_marks_spencer_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_marks_spencer_$today.csv

# Ketjuvalikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_smarket_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_smarket_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='F' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='F' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_smarket_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='F' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='F' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_smarket_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikalkpvm_smarket:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikloppvm_smarket:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_smarket:erase_before\" from customer._ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_smarket_$today.csv

# Tilausmyyntivalikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_smarket_out;"
# Current Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_smarket_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_smarket_out);"
# Past Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='FA' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_smarket_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tilausmyynti_sm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tilausmyynti_sm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tilausmyynti_sm_luokka:erase_before\" from customer._ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tilausmyynti_smarket_$today.csv

# KT-vaihtuva valikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_smarket_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_smarket_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_smarket_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='FE' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_smarket_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_sm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_sm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_sm_luokka:erase_before\" from customer._ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_kt_vaihtuva_smarket_$today.csv

# Lisävalikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_smarket_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_smarket_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_smarket_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_smarket_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='FL' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_smarket_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_sm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_sm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_sm_luokka:erase_before\" from customer._ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_lisavalikoima_smarket_$today.csv

# Ketjuvalikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_pienmla_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Y' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Y' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_pienmla_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Y' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='Y' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_pienmla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikalkpvm_pienmla:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikloppvm_pienmla:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_pienmla:erase_before\" from customer._ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_pienmla_$today.csv

# Tilausmyyntivalikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_pienmla_out;"
# Current Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_pienmla_out);"
# Past Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='YA' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_pienmla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tilausmyynti_pm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tilausmyynti_pm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tilausmyynti_pm_luokka:erase_before\" from customer._ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tilausmyynti_pienmla_$today.csv

# KT-vaihtuva valikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_pienmla_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_pienmla_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='YE' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_pienmla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_pm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_pm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_pm_luokka:erase_before\" from customer._ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_kt_vaihtuva_pienmla_$today.csv

# Lisävalikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_pienmla_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_pienmla_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_pienmla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='YL' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_pienmla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_pm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_pm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_pm_luokka:erase_before\" from customer._ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_lisavalikoima_pienmla_$today.csv

# Ketjuvalikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_liikennemla_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='K' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='K' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='K' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='K' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikalkpvm_liikennemla:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikloppvm_liikennemla:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_liikennemla:erase_before\" from customer._ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_liikennemla_$today.csv

# Tilausmyyntivalikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_liikennemla_out;"
# Current Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
# Past Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='KA' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tilausmyynti_ab_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tilausmyynti_ab_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tilausmyynti_ab_luokka:erase_before\" from customer._ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tilausmyynti_liikennemla_$today.csv

# KT-vaihtuva valikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_liikennemla_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='KE' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_ab_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_ab_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_ab_luokka:erase_before\" from customer._ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_kt_vaihtuva_liikennemla_$today.csv

# Lisävalikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_liikennemla_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_liikennemla_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='KL' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_liikennemla_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_ab_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_ab_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_ab_luokka:erase_before\" from customer._ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_lisavalikoima_liikennemla_$today.csv

# Ketjuvalikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_srauta_out;"
# Current Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_srauta_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='R' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='R' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_srauta_out);"
# Past Ketjuvalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='R' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where left(customer_ketjuvalikoimaluokka,1)='R' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_srauta_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_ketjuvalikoimaluokan_alkupvm_srauta:erase_before\", customer_ketjuvalikloppvm \"customer_ketjuvalikoimaluokan_loppupvm_srauta:erase_before\", customer_ketjuvalikoimaluokka \"customer_ketjuvalikoimaluokka_srauta:erase_before\" from customer._ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_ketjuvalikoima_srauta_$today.csv

# Tilausmyyntivalikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_srauta_out;"
# Current Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_srauta_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_srauta_out);"
# Past Tilausmyyntivalikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='RA' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_srauta_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tilausmyynti_sr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tilausmyynti_sr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tilausmyynti_sr_luokka:erase_before\" from customer._ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tilausmyynti_srauta_$today.csv

# KT-vaihtuva valikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_srauta_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_srauta_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_srauta_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='RE' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_srauta_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_sr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_sr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_sr_luokka:erase_before\" from customer._ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_kt_vaihtuva_srauta_$today.csv

# Lisävalikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._ketjuvalikoima_srauta_out;"
# Current KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "select * into customer._ketjuvalikoima_srauta_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm;"
# Future KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select * from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and code not in (select code from customer._ketjuvalikoima_srauta_out);"
# Past KT-vaihtuva valikoimaluokka
psql processor-sok-kt-preprocess_production -c "insert into customer._ketjuvalikoima_srauta_out select _ketjuvalikoima.* from customer._ketjuvalikoima, (select code, max(customer_ketjuvalikloppvm) max_date from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm group by code) max_date where customer_ketjuvalikoimaluokka='RL' and _ketjuvalikoima.code=max_date.code and customer_ketjuvalikloppvm=max_date.max_date and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end > _ketjuvalikoima.customer_ketjuvalikloppvm and _ketjuvalikoima.code not in (select code from customer._ketjuvalikoima_srauta_out);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_sr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_sr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_sr_luokka:erase_before\" from customer._ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_lisavalikoima_srauta_$today.csv

# Tuleva ketjuvalikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_terra_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_terra_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='T' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='T' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tulevan_ketjuvalikoiman_alku_pvm_tr:erase_before\", customer_ketjuvalikloppvm \"customer_tulevan_ketjuvalikoiman_loppu_pvm_tr:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_ketjuvalikoimaluokka_tr:erase_before\" from customer._tuleva_ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_ketjuvalikoima_terra_$today.csv

# Tuleva tilausmyyntivalikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_terra_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_terra_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tuleva_tilausmyynti_tr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tuleva_tilausmyynti_tr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_tilausmyynti_tr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_tilausmyynti_terra_$today.csv

# Tuleva KT-vaihtuva valikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_terra_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_terra_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_tr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_tr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_tr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_kt_vaihtuva_terra_$today.csv

# Tuleva lisävalikoimaluokka Terra message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_terra_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_terra_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='TL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_tr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_tr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_tr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_terra_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_lisavalikoima_terra_$today.csv

# Tuleva ketjuvalikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_prisma_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_prisma_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='C' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='C' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tulevan_ketjuvalikoiman_alku_pvm_pr:erase_before\", customer_ketjuvalikloppvm \"customer_tulevan_ketjuvalikoiman_loppu_pvm_pr:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_ketjuvalikoimaluokka_pr:erase_before\" from customer._tuleva_ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_ketjuvalikoima_prisma_$today.csv

# Tuleva tilausmyyntivalikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_prisma_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_prisma_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tuleva_tilausmyynti_pr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tuleva_tilausmyynti_pr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_tilausmyynti_pr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_tilausmyynti_prisma_$today.csv

# Tuleva KT-vaihtuva valikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_prisma_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_prisma_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_pr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_pr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_pr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_kt_vaihtuva_prisma_$today.csv

# Tuleva lisävalikoimaluokka Prisma message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_prisma_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_prisma_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='CL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_pr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_pr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_pr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_prisma_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_lisavalikoima_prisma_$today.csv

# Tuleva ketjuvalikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_smarket_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_smarket_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='F' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='F' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tulevan_ketjuvalikoiman_alku_pvm_sm:erase_before\", customer_ketjuvalikloppvm \"customer_tulevan_ketjuvalikoiman_loppu_pvm_sm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_ketjuvalikoimaluokka_sm:erase_before\" from customer._tuleva_ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_ketjuvalikoima_smarket_$today.csv

# Tuleva tilausmyyntivalikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_smarket_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_smarket_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tuleva_tilausmyynti_sm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tuleva_tilausmyynti_sm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_tilausmyynti_sm_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_tilausmyynti_smarket_$today.csv

# Tuleva KT-vaihtuva valikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_smarket_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_smarket_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_sm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_sm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_sm_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_kt_vaihtuva_smarket_$today.csv

# Tuleva lisävalikoimaluokka S-market message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_smarket_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_smarket_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='FL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_sm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_sm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_sm_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_smarket_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_lisavalikoima_smarket_$today.csv

# Tuleva ketjuvalikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_pienmla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Y' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='Y' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tulevan_ketjuvalikoiman_alku_pvm_pm:erase_before\", customer_ketjuvalikloppvm \"customer_tulevan_ketjuvalikoiman_loppu_pvm_pm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_ketjuvalikoimaluokka_pm:erase_before\" from customer._tuleva_ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_ketjuvalikoima_pienmla_$today.csv

# Tuleva tilausmyyntivalikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_pienmla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tuleva_tilausmyynti_pm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tuleva_tilausmyynti_pm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_tilausmyynti_pm_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_tilausmyynti_pienmla_$today.csv

# Tuleva KT-vaihtuva valikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_pienmla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_pm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_pm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_pm_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_kt_vaihtuva_pienmla_$today.csv

# Tuleva lisävalikoimaluokka Pienmyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_pienmla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_pienmla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='YL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_pm_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_pm_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_pm_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_pienmla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_lisavalikoima_pienmla_$today.csv

# Tuleva ketjuvalikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_liikennemla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='K' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='K' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tulevan_ketjuvalikoiman_alku_pvm_ab:erase_before\", customer_ketjuvalikloppvm \"customer_tulevan_ketjuvalikoiman_loppu_pvm_ab:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_ketjuvalikoimaluokka_ab:erase_before\" from customer._tuleva_ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_ketjuvalikoima_liikennemla_$today.csv

# Tuleva tilausmyyntivalikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_liikennemla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tuleva_tilausmyynti_ab_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tuleva_tilausmyynti_ab_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_tilausmyynti_ab_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_tilausmyynti_liikennemla_$today.csv

# Tuleva KT-vaihtuva valikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_liikennemla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_ab_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_ab_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_ab_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_kt_vaihtuva_liikennemla_$today.csv

# Tuleva lisävalikoimaluokka Liikennemyymälä message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_liikennemla_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_liikennemla_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='KL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_ab_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_ab_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_ab_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_liikennemla_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_lisavalikoima_liikennemla_$today.csv

# Tuleva ketjuvalikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_srauta_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_srauta_out from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='R' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)='R' and right(customer_ketjuvalikoimaluokka, 1) ~ '[0-9]' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tulevan_ketjuvalikoiman_alku_pvm_sr:erase_before\", customer_ketjuvalikloppvm \"customer_tulevan_ketjuvalikoiman_loppu_pvm_sr:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_ketjuvalikoimaluokka_sr:erase_before\" from customer._tuleva_ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_ketjuvalikoima_srauta_$today.csv

# Tuleva tilausmyyntivalikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_srauta_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_srauta_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RA' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_tuleva_tilausmyynti_sr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_tuleva_tilausmyynti_sr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_tuleva_tilausmyynti_sr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_tilausmyynti_srauta_$today.csv

# Tuleva KT-vaihtuva valikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_srauta_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_srauta_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RE' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_kt_vaihtuva_sr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_kt_vaihtuva_sr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_kt_vaihtuva_sr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_kt_vaihtuva_srauta_$today.csv

# Tuleva lisävalikoimaluokka S-rauta message
psql processor-sok-kt-preprocess_production -c "drop table customer._tuleva_ketjuvalikoima_srauta_out;"
psql processor-sok-kt-preprocess_production -c "select * into customer._tuleva_ketjuvalikoima_srauta_out from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm and (code, customer_ketjuvalikalkpvm) in (select code, min(customer_ketjuvalikalkpvm) from customer._ketjuvalikoima where customer_ketjuvalikoimaluokka='RL' and current_date + case when date_part('hour', current_time) > 18 then 1 else 0 end  < _ketjuvalikoima.customer_ketjuvalikalkpvm group by code);"
psql processor-sok-kt-preprocess_production -c "copy (select code, customer_ketjuvalikalkpvm \"customer_lisavalikoima_sr_alkupvm:erase_before\", customer_ketjuvalikloppvm \"customer_lisavalikoima_sr_loppupvm:erase_before\", customer_ketjuvalikoimaluokka \"customer_lisavalikoima_sr_luokka:erase_before\" from customer._tuleva_ketjuvalikoima_srauta_out) to stdout WITH CSV HEADER DELIMITER ';';" > ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_tuleva_lisavalikoima_srauta_$today.csv

# Fix headers to erase_before_rading (header too long for psql)
sed -i 's/erase_before/erase_before_reading/g' ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_*ketjuvalikoima_*
sed -i 's/erase_before/erase_before_reading/g' ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_*tilausmyynti_*
sed -i 's/erase_before/erase_before_reading/g' ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_*kt_vaihtuva_*
sed -i 's/erase_before/erase_before_reading/g' ${MESSAGES_INPUT_TEMP_FOLDER}Product_Update_*lisavalikoima_*

mv ${MESSAGES_INPUT_TEMP_FOLDER}* ${MESSAGES_INPUT}

rm ${MESSAGES_INPUT}*_UTF8
#/opt/apps/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('select 1', 'Loading additional product info complete')"
