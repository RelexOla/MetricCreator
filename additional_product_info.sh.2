/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('select 1', 'Start loading additional product info')"
date >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
echo "Esillepanoryhma"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Esillepanoryhma_* &> /dev/null; 
then 
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Esillepanoryhma_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._esillepanoryhma_in; copy customer._esillepanoryhma_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._esillepanoryhma where code in (select code from customer._esillepanoryhma_in); insert into customer._esillepanoryhma select * from customer._esillepanoryhma_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done 
else 
echo "No esillepanoryhma files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log 
fi
echo "Tavararyhma"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Tavararyhma_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Tavararyhma_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._tavararyhma_in; copy customer._tavararyhma_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._tavararyhma where code in (select code from customer._tavararyhma_in); insert into customer._tavararyhma select * from customer._tavararyhma_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No tavararyhma files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Ketjuvalikoima"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Ketjuvalikoima_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Ketjuvalikoima_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._ketjuvalikoima_in; copy customer._ketjuvalikoima_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._ketjuvalikoima using customer._ketjuvalikoima_in where _ketjuvalikoima.code=_ketjuvalikoima_in.code and _ketjuvalikoima.customer_ketjuvalikalkpvm=_ketjuvalikoima_in.customer_ketjuvalikalkpvm; insert into customer._ketjuvalikoima select code, customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm, customer_ketjuvalikoimaluokka from customer._ketjuvalikoima_in where customer_tila='5';" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No ketjuvalikoima files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Tilausvalikoima"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Tilausvalikoima_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Tilausvalikoima_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._tilausvalikoima_in; copy customer._tilausvalikoima_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._tilausvalikoima using customer._tilausvalikoima_in where _tilausvalikoima.product_code=_tilausvalikoima_in.product_code and _tilausvalikoima.outlet_code=_tilausvalikoima_in.outlet_code and (_tilausvalikoima_in.customer_tilausvalikoiman_alkupaiva=_tilausvalikoima.customer_tilausvalikoiman_alkupaiva or _tilausvalikoima_in.customer_tilausvalikoiman_alkupaiva is null); insert into customer._tilausvalikoima select product_code, outlet_code, customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva from customer._tilausvalikoima_in where customer_poistunut is null;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No tilausvalikoima files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Toimituspakkaus"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Toimituspakkaus_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Toimituspakkaus_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._toimituspakkaus_in; copy customer._toimituspakkaus_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._toimituspakkaus where code in (select code from customer._toimituspakkaus_in); insert into customer._toimituspakkaus select * from customer._toimituspakkaus_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No toimituspakkaus files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Toimittaja"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Toimittaja_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Toimittaja_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._toimituspakkaus_in; copy customer._toimittaja_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._toimittaja where code in (select code from customer._toimittaja_in); insert into customer._toimittaja select * from customer._toimittaja_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No toimitaja files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Suositushinta"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Suositushinta_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Suositushinta_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._suositushinta_in; copy customer._suositushinta_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._suositushinta using customer._suositushinta_in where _suositushinta_in.ketju=_suositushinta.ketju and _suositushinta_in.product_code=_suositushinta.product_code and _suositushinta_in.customer_suositushinta_alkupvm=_suositushinta.customer_suositushinta_alkupvm; insert into customer._suositushinta select * from customer._suositushinta_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No suositushinta files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Tilausluokka"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Tilausluokka_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Tilausluokka_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._tilausluokka_in; copy customer._tilausluokka_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._tilausluokka where customer_toimpakkavain in (select customer_toimpakkavain from customer._tilausluokka_in); insert into customer._tilausluokka select * from customer._tilausluokka_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No tilausluokka files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
echo "Kaytettavatoimittaja"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
if ls /opt/capistrano/processor-sok-kt/data/messages/input/Kaytettavatoimittaja_* &> /dev/null;
then
for i in /opt/capistrano/processor-sok-kt/data/messages/input/Kaytettavatoimittaja_*; do iconv -f ISO8859-1 -t UTF-8 "$i" > "$i"_UTF8; psql processor-sok-kt_production -c "truncate table customer._kaytettavatoimittaja_in; copy customer._kaytettavatoimittaja_in from '"$i"_UTF8' with csv delimiter as ';' header; delete from customer._kaytettavatoimittaja using customer._kaytettavatoimittaja_in where _kaytettavatoimittaja_in.outlet_code=_kaytettavatoimittaja.outlet_code and _kaytettavatoimittaja_in.product_code=_kaytettavatoimittaja.product_code and _kaytettavatoimittaja_in.customer_kaytettavatoimittaja_alkupvm=_kaytettavatoimittaja.customer_kaytettavatoimittaja_alkupvm; insert into customer._kaytettavatoimittaja select * from customer._kaytettavatoimittaja_in;" >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log; mv $i /opt/capistrano/processor-sok-kt/data/messages/processed/; done
else
echo "No kaytettavatoimittaja files"  >> /opt/capistrano/processor-sok-kt/scripts/additional_product_info.log
fi
# Avataan tilausvalikoiman tuotteet
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('drop table customer._product_location_opener;','Poistetaan väliaikaistaulu')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('select distinct tv.outlet_code,tv.product_code into customer._product_location_opener from customer._tilausvalikoima tv left join (select pm.code p_code,o.code o_code from ui.c_products p,ui.product_masters pm, ui.outlets o where p.outlet_id=o.id and p.product_master_id=pm.id) p on p.p_code=tv.product_code and p.o_code=tv.outlet_code where p.p_code is null;','Kaikki tilausvalikoiman tuotteet, jotka eivät ole auki')"
psql processor-sok-kt_production -c"copy customer._product_location_opener to stdout with delimiter ';' csv header" > /opt/capistrano/processor-sok-kt/data/messages/input/Location_Update_TV_$today.csv
# Create general supplier message
psql processor-sok-kt_production -c "copy (select kt.product_code, temp.outlet_code, kt.customer_supplier supplier from (select * from customer._kaytettavatoimittaja where current_date between customer_kaytettavatoimittaja_alkupvm and customer_kaytettavatoimittaja_loppupvm and outlet_code='0') kt, (select pm.code product_code, o.code outlet_code, s.code supplier_code from ui.product_masters pm, ui.outlets o,ui.c_products p left join ui.suppliers s on p.supplier_id=s.id where p.product_master_id=pm.id and p.outlet_id=o.id) temp where kt.product_code=temp.product_code and coalesce(temp.supplier_code,'')<>kt.customer_supplier) to stdout WITH CSV HEADER DELIMITER ';';" > /opt/capistrano/processor-sok-kt/data/messages/input/Location_Update_kaytettavatoimittaja_no_outlet_code_$today.csv
# Create supplier message based on locations
psql processor-sok-kt_production -c "copy (select product_code, outlet_code, customer_supplier supplier from customer._kaytettavatoimittaja where current_date between customer_kaytettavatoimittaja_alkupvm and customer_kaytettavatoimittaja_loppupvm and outlet_code<>'0') to stdout WITH CSV HEADER DELIMITER ';';" > /opt/capistrano/processor-sok-kt/data/messages/input/Location_Update_kaytettavatoimittaja_$today.csv
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "RunProcessor.execute_ui_scripts()"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr8_nimi=_esillepanoryhma.name, customer_epr7_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr8_tunnus and taso=8 and (coalesce(customer_epr8_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr7_tunnus,\'\')<>parent);','Esillepanoryhmä 8')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr7_nimi=_esillepanoryhma.name, customer_epr6_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr7_tunnus and taso=7 and (coalesce(customer_epr7_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr6_tunnus,\'\')<>parent);','Esillepanoryhmä 7')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr6_nimi=_esillepanoryhma.name, customer_epr5_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr6_tunnus and taso=6 and (coalesce(customer_epr6_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr5_tunnus,\'\')<>parent);','Esillepanoryhmä 6')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr5_nimi=_esillepanoryhma.name, customer_epr4_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr5_tunnus and taso=5 and (coalesce(customer_epr5_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr4_tunnus,\'\')<>parent);','Esillepanoryhmä 5')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr4_nimi=_esillepanoryhma.name, customer_epr3_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr4_tunnus and taso=4 and (coalesce(customer_epr4_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr3_tunnus,\'\')<>parent);','Esillepanoryhmä 4')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr3_nimi=_esillepanoryhma.name, customer_epr2_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr3_tunnus and taso=3 and (coalesce(customer_epr3_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr2_tunnus,\'\')<>parent);','Esillepanoryhmä 3')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr2_nimi=_esillepanoryhma.name, customer_epr1_tunnus=parent from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr2_tunnus and taso=2 and (coalesce(customer_epr2_nimi,\'\')<>_esillepanoryhma.name or coalesce(customer_epr1_tunnus,\'\')<>parent);','Esillepanoryhmä 2')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_epr1_nimi=_esillepanoryhma.name from customer._esillepanoryhma where _esillepanoryhma.code=customer_epr1_tunnus and taso=1 and coalesce(customer_epr1_nimi,\'\')<>_esillepanoryhma.name;','Esillepanoryhmä 1')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_tr6_nimi=_tavararyhma.name, customer_tr6_tunnus=tunnus, customer_tr5_tunniste=parent from customer._tavararyhma where _tavararyhma.code=customer_tr6_tunniste and (coalesce(customer_tr6_nimi,\'\')<>_tavararyhma.name or coalesce(customer_tr6_tunnus,\'\')<>tunnus or coalesce(customer_tr5_tunniste,\'\')<>parent);','Tavararyhmä 6')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_tr5_nimi=_tavararyhma.name, customer_tr5_tunnus=tunnus, customer_tr4_tunniste=parent from customer._tavararyhma where _tavararyhma.code=customer_tr5_tunniste and (coalesce(customer_tr5_nimi,\'\')<>_tavararyhma.name or coalesce(customer_tr5_tunnus,\'\')<>tunnus or coalesce(customer_tr4_tunniste,\'\')<>parent);','Tavararyhmä 5')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_tr4_nimi=_tavararyhma.name, customer_tr4_tunnus=tunnus, customer_tr3_tunniste=parent from customer._tavararyhma where _tavararyhma.code=customer_tr4_tunniste and (coalesce(customer_tr4_nimi,\'\')<>_tavararyhma.name or coalesce(customer_tr4_tunnus,\'\')<>tunnus or coalesce(customer_tr3_tunniste,\'\')<>parent);','Tavararyhmä 4')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_tr3_nimi=_tavararyhma.name, customer_tr3_tunnus=tunnus, customer_tr2_tunniste=parent from customer._tavararyhma where _tavararyhma.code=customer_tr3_tunniste and (coalesce(customer_tr3_nimi,\'\')<>_tavararyhma.name or coalesce(customer_tr3_tunnus,\'\')<>tunnus or coalesce(customer_tr2_tunniste,\'\')<>parent);','Tavararyhmä 3')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_tr2_nimi=_tavararyhma.name, customer_tr2_tunnus=tunnus, customer_tr1_tunniste=parent from customer._tavararyhma where _tavararyhma.code=customer_tr2_tunniste and (coalesce(customer_tr2_nimi,\'\')<>_tavararyhma.name or coalesce(customer_tr2_tunnus,\'\')<>tunnus or coalesce(customer_tr1_tunniste,\'\')<>parent);','Tavararyhmä 2')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_tr1_nimi=_tavararyhma.name, customer_tr1_tunnus=tunnus from customer._tavararyhma where _tavararyhma.code=customer_tr1_tunniste and (coalesce(customer_tr1_nimi,\'\')<>_tavararyhma.name or coalesce(customer_tr1_tunnus,\'\')<>tunnus);','Tavararyhmä 1')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_terra=null, customer_ketjuvalikalkpvm_terra=null,customer_ketjuvalikloppvm_terra=null, customer_ketjuvalikoimaluokka_prisma=null, customer_ketjuvalikalkpvm_prisma=null, customer_ketjuvalikloppvm_prisma=null;','Ketjuvalikoimatiedon tyhjennys')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_terra=_ketjuvalikoima.customer_ketjuvalikoimaluokka, customer_ketjuvalikalkpvm_terra=_ketjuvalikoima.customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm_terra=_ketjuvalikoima.customer_ketjuvalikloppvm from (select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'T\' and CURRENT_DATE between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm) _ketjuvalikoima where _ketjuvalikoima.code=product_masters.code;','Voimassaolevat Terra-ketjuvalikoimat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_prisma=_ketjuvalikoima.customer_ketjuvalikoimaluokka, customer_ketjuvalikalkpvm_prisma=_ketjuvalikoima.customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm_prisma=_ketjuvalikoima.customer_ketjuvalikloppvm from (select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'C\' and CURRENT_DATE between _ketjuvalikoima.customer_ketjuvalikalkpvm and _ketjuvalikoima.customer_ketjuvalikloppvm) _ketjuvalikoima where _ketjuvalikoima.code=product_masters.code;','Voimassaolevat Prisma-ketjuvalikoimat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_terra=_ketjuvalikoima.customer_ketjuvalikoimaluokka, customer_ketjuvalikalkpvm_terra=_ketjuvalikoima.customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm_terra=_ketjuvalikoima.customer_ketjuvalikloppvm from (select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'T\' and CURRENT_DATE < _ketjuvalikoima.customer_ketjuvalikalkpvm) _ketjuvalikoima where _ketjuvalikoima.code=product_masters.code and customer_ketjuvalikoimaluokka_terra is null;','Tulevat Terra-ketjuvalikoimat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_prisma=_ketjuvalikoima.customer_ketjuvalikoimaluokka, customer_ketjuvalikalkpvm_prisma=_ketjuvalikoima.customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm_prisma=_ketjuvalikoima.customer_ketjuvalikloppvm from (select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'C\' and CURRENT_DATE < _ketjuvalikoima.customer_ketjuvalikalkpvm) _ketjuvalikoima where _ketjuvalikoima.code=product_masters.code and customer_ketjuvalikoimaluokka_prisma is null;','Tulevat Prisma-ketjuvalikoimat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_terra=_ketjuvalikoima.customer_ketjuvalikoimaluokka, customer_ketjuvalikalkpvm_terra=_ketjuvalikoima.customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm_terra=_ketjuvalikoima.customer_ketjuvalikloppvm from (select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'T\' and _ketjuvalikoima.customer_ketjuvalikloppvm in(select max(_ketjuvalikoima.customer_ketjuvalikloppvm) from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'T\' and CURRENT_DATE > _ketjuvalikoima.customer_ketjuvalikloppvm)) _ketjuvalikoima where _ketjuvalikoima.code=product_masters.code and customer_ketjuvalikoimaluokka_terra is null;','Päättyneet Terra-ketjuvalikoimat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_ketjuvalikoimaluokka_prisma=_ketjuvalikoima.customer_ketjuvalikoimaluokka, customer_ketjuvalikalkpvm_prisma=_ketjuvalikoima.customer_ketjuvalikalkpvm, customer_ketjuvalikloppvm_prisma=_ketjuvalikoima.customer_ketjuvalikloppvm from (select * from customer._ketjuvalikoima where left(customer_ketjuvalikoimaluokka,1)=\'C\' and CURRENT_DATE > _ketjuvalikoima.customer_ketjuvalikloppvm) _ketjuvalikoima where _ketjuvalikoima.code=product_masters.code and customer_ketjuvalikoimaluokka_prisma is null;','Päättyneet Prisma-ketjuvalikoimat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products set customer_tilausvalikoiman_alkupaiva=_tilausvalikoima.customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva=_tilausvalikoima.customer_tilausvalikoiman_loppupaiva from ui.outlets o, ui.product_masters pm, (select t.* from customer._tilausvalikoima t, (select product_code, outlet_code, max(customer_tilausvalikoiman_alkupaiva) alkupv from customer._tilausvalikoima where current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end>customer_tilausvalikoiman_loppupaiva  group by product_code, outlet_code) sd where t.product_code=sd.product_code and t.outlet_code=sd.outlet_code and t.customer_tilausvalikoiman_alkupaiva=sd.alkupv) _tilausvalikoima where o.id=c_products.outlet_id and o.code=_tilausvalikoima.outlet_code and pm.id=c_products.product_master_id and pm.code=_tilausvalikoima.product_code and (c_products.customer_tilausvalikoiman_alkupaiva is null or c_products.customer_tilausvalikoiman_alkupaiva<>_tilausvalikoima.customer_tilausvalikoiman_alkupaiva or c_products.customer_tilausvalikoiman_loppupaiva<>_tilausvalikoima.customer_tilausvalikoiman_loppupaiva);','Menneet tilausvalikoimapäivämäärät')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products set customer_tilausvalikoiman_alkupaiva=_tilausvalikoima.customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva=_tilausvalikoima.customer_tilausvalikoiman_loppupaiva from ui.outlets o, ui.product_masters pm, (select t.* from customer._tilausvalikoima t, (select product_code, outlet_code, max(customer_tilausvalikoiman_alkupaiva) alkupv from customer._tilausvalikoima where current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end<customer_tilausvalikoiman_alkupaiva  group by product_code, outlet_code) sd where t.product_code=sd.product_code and t.outlet_code=sd.outlet_code and t.customer_tilausvalikoiman_alkupaiva=sd.alkupv) _tilausvalikoima where o.id=c_products.outlet_id and o.code=_tilausvalikoima.outlet_code and pm.id=c_products.product_master_id and pm.code=_tilausvalikoima.product_code and (c_products.customer_tilausvalikoiman_alkupaiva is null or c_products.customer_tilausvalikoiman_alkupaiva<>_tilausvalikoima.customer_tilausvalikoiman_alkupaiva or c_products.customer_tilausvalikoiman_loppupaiva<>_tilausvalikoima.customer_tilausvalikoiman_loppupaiva);','Tulevat tilausvalikoimapäivämäärät')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products set customer_tilausvalikoiman_alkupaiva=_tilausvalikoima.customer_tilausvalikoiman_alkupaiva, customer_tilausvalikoiman_loppupaiva=_tilausvalikoima.customer_tilausvalikoiman_loppupaiva from ui.outlets o, ui.product_masters pm, (select t.* from customer._tilausvalikoima t, (select product_code, outlet_code, max(customer_tilausvalikoiman_alkupaiva) alkupv from customer._tilausvalikoima where current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end between customer_tilausvalikoiman_alkupaiva and customer_tilausvalikoiman_loppupaiva group by product_code, outlet_code) sd where t.product_code=sd.product_code and t.outlet_code=sd.outlet_code and t.customer_tilausvalikoiman_alkupaiva=sd.alkupv) _tilausvalikoima where o.id=c_products.outlet_id and o.code=_tilausvalikoima.outlet_code and pm.id=c_products.product_master_id and pm.code=_tilausvalikoima.product_code and (c_products.customer_tilausvalikoiman_alkupaiva is null or c_products.customer_tilausvalikoiman_alkupaiva<>_tilausvalikoima.customer_tilausvalikoiman_alkupaiva or c_products.customer_tilausvalikoiman_loppupaiva<>_tilausvalikoima.customer_tilausvalikoiman_loppupaiva);','Voimassaolevat tilausvalikoimapäivämäärät')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products set customer_tilausvalikoiman_alkupaiva=null, customer_tilausvalikoiman_loppupaiva=null from (select id from (select p.id,o.code ocode, pm.code pmcode from ui.c_products p, ui.outlets o, ui.product_masters pm where o.id=p.outlet_id and pm.id=p.product_master_id and customer_tilausvalikoiman_alkupaiva is not null) temp left join customer._tilausvalikoima on temp.ocode=_tilausvalikoima.outlet_code and temp.pmcode=_tilausvalikoima.product_code where product_code is null) temp2 where c_products.id=temp2.id;','Poistetaan poistetut tilausvalikoimasta')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products set customer_tilausvalikoimassa=false where customer_tilausvalikoimassa and (current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end < customer_tilausvalikoiman_alkupaiva or current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end>customer_tilausvalikoiman_loppupaiva or customer_tilausvalikoiman_loppupaiva is null);','Tilausvalikoimassa falseksi')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products set customer_tilausvalikoimassa=true where customer_tilausvalikoimassa=false and current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end between customer_tilausvalikoiman_alkupaiva and customer_tilausvalikoiman_loppupaiva;','Tilausvalikoimassa trueksi')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_toimpakk1tunnus=toimpakk.tunnus1, customer_toimpakk1tyyppi=toimpakk.tyyppi1, customer_toimpakk1maara=toimpakk.maara1, customer_toimpakk2tunnus=toimpakk.tunnus2, customer_toimpakk2tyyppi=toimpakk.tyyppi2, customer_toimpakk2maara=toimpakk.maara2, customer_toimpakk3tunnus=toimpakk.tunnus3, customer_toimpakk3tyyppi=toimpakk.tyyppi3, customer_toimpakk3maara=toimpakk.maara3, customer_toimpakk4tunnus=toimpakk.tunnus4, customer_toimpakk4tyyppi=toimpakk.tyyppi4, customer_toimpakk4maara=toimpakk.maara4, customer_toimpakk5tunnus=toimpakk.tunnus5, customer_toimpakk5tyyppi=toimpakk.tyyppi5, customer_toimpakk5maara=toimpakk.maara5 from (select code, tunnus_array[1] as tunnus1, tunnus_array[2] as tunnus2, tunnus_array[3] as tunnus3, tunnus_array[4] as tunnus4, tunnus_array[5] as tunnus5, tyyppi_array[1] as tyyppi1, tyyppi_array[2] as tyyppi2, tyyppi_array[3] as tyyppi3, tyyppi_array[4] as tyyppi4, tyyppi_array[5] as tyyppi5, maara_array[1] as maara1, maara_array[2] as maara2, maara_array[3] as maara3, maara_array[4] as maara4, maara_array[5] as maara5 from (select code,ui.array_accum(customer_toimpakktunnus) as tunnus_array, ui.array_accum(customer_toimpakktyyppi) as tyyppi_array, ui.array_accum(customer_toimpakkmaara) as maara_array from (select code, customer_toimpakktunnus, customer_toimpakktyyppi, customer_toimpakkmaara from customer._toimituspakkaus where current_date between customer_toimpakkalkpvm and customer_toimpakkloppvm and current_date between customer_toimpakkmalkpvm and customer_toimpakkmloppvm order by code, customer_toimpakkmaara asc) a group by a.code) b) toimpakk where ui.product_masters.code=toimpakk.code and (coalesce(customer_toimpakk1tunnus,\'\')<>toimpakk.tunnus1 or coalesce(customer_toimpakk1tyyppi,\'\')<>toimpakk.tyyppi1 or coalesce(customer_toimpakk1maara,0)<>toimpakk.maara1 or coalesce(customer_toimpakk2tunnus,\'\')<>toimpakk.tunnus2 or coalesce(customer_toimpakk2tyyppi,\'\')<>toimpakk.tyyppi2 or coalesce(customer_toimpakk2maara,0)<>toimpakk.maara2 or coalesce(customer_toimpakk3tunnus,\'\')<>toimpakk.tunnus3 or coalesce(customer_toimpakk3tyyppi,\'\')<>toimpakk.tyyppi3 or coalesce(customer_toimpakk3maara,0)<>toimpakk.maara3 or coalesce(customer_toimpakk4tunnus,\'\')<>toimpakk.tunnus4 or coalesce(customer_toimpakk4tyyppi,\'\')<>toimpakk.tyyppi4 or coalesce(customer_toimpakk4maara,0)<>toimpakk.maara4 or coalesce(customer_toimpakk5tunnus,\'\')<>toimpakk.tunnus5 or coalesce(customer_toimpakk5tyyppi,\'\')<>toimpakk.tyyppi5 or coalesce(customer_toimpakk5maara,0)<>toimpakk.maara5);','Toimituspakkaukset')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.product_masters set customer_valmistaja_nimi=_toimittaja.name, customer_valmistaja_ly=_toimittaja.customer_ly, customer_valmistaja_tilotunnus=_toimittaja.customer_tilotunnus from customer._toimittaja where _toimittaja.code=customer_valmistaja and (coalesce(customer_valmistaja_nimi,\'\')<>_toimittaja.name or coalesce(customer_valmistaja_ly,\'\')<>_toimittaja.customer_ly or coalesce(customer_valmistaja_tilotunnus,\'\')<>_toimittaja.customer_tilotunnus);','Valmistajatiedot')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set sales_price=h.hinta, purchase_price=h.hinta from ui.outlets o, ui.product_masters pm, ui.chains c, (select customer._suositushinta.* from customer._suositushinta, (select product_code, ketju, max(customer_muutosaika) max_muutosaika from customer._suositushinta where current_date + case when date_part(\'hour\', current_time) > 18 then 1 else 0 end between customer_suositushinta_alkupvm and customer_suositushinta_loppupvm group by product_code, ketju) lh where customer._suositushinta.product_code=lh.product_code and customer._suositushinta.ketju=lh.ketju and customer._suositushinta.customer_muutosaika=lh.max_muutosaika) h where p.outlet_id=o.id and p.product_master_id=pm.id and o.chain_id=c.id and case c.code when \'PRISMA\' then \'02\' when \'TERRA\' then \'70\' end=h.ketju and pm.code=product_code and (coalesce(p.sales_price,0)<>h.hinta or coalesce(p.purchase_price,0)<>h.hinta);','Suositushinta')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('vacuum analyze ui.c_products', 'Huoltoajo')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('vacuum analyze customer._tilausluokka', 'Huoltoajo')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set customer_toimittajan_tilausluokka=kt.customer_toimittajan_oletustilausluokka from ui.product_masters pm, (select * from customer._kaytettavatoimittaja where outlet_code=\'0\') kt, ui.suppliers s where p.product_master_id=pm.id and p.supplier_id=s.id and pm.code=kt.product_code and s.code=kt.customer_supplier and current_date between customer_kaytettavatoimittaja_alkupvm and customer_kaytettavatoimittaja_loppupvm and coalesce(p.customer_toimittajan_tilausluokka,\'\')<>coalesce(kt.customer_toimittajan_oletustilausluokka,\'\') and p.id not in (select p.id from ui.c_products p, ui.outlets o, ui.suppliers s, ui.product_masters pm,(select supplier, outlet_code,customer_toimittajan_tilausluokka, customer_toimpakkavain from customer._tilausluokka  where outlet_code<>\'0\') tl where p.outlet_id=o.id and p.product_master_id=pm.id and p.supplier_id=s.id and tl.supplier=s.code and tl.outlet_code=o.code and tl.customer_toimpakkavain=p.customer_toimpakktunnus and p.customer_toimpakktunnus is not null);','Oletustilausluokat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set customer_toimittajan_tilausluokka=kt.customer_toimittajan_oletustilausluokka from ui.product_masters pm, (select * from customer._kaytettavatoimittaja where outlet_code<>\'0\') kt, ui.outlets o, ui.suppliers s where p.product_master_id=pm.id and p.outlet_id=o.id and p.supplier_id=s.id and pm.code=kt.product_code and o.code=kt.outlet_code and s.code=kt.customer_supplier and current_date between customer_kaytettavatoimittaja_alkupvm and customer_kaytettavatoimittaja_loppupvm and coalesce(p.customer_toimittajan_tilausluokka,\'\')<>coalesce(kt.customer_toimittajan_oletustilausluokka,\'\');','Lokaatiokohtaiset oletustilausluokat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set customer_toimittajan_tilausluokka=tl.customer_toimittajan_tilausluokka from ui.product_masters pm, ui.suppliers s,(select supplier, outlet_code,customer_toimittajan_tilausluokka, customer_toimpakkavain from customer._tilausluokka  where outlet_code=\'0\') tl where p.product_master_id=pm.id and p.supplier_id=s.id and tl.supplier=s.code and tl.customer_toimpakkavain=p.customer_toimpakktunnus and p.customer_toimpakktunnus is not null and coalesce(p.customer_toimittajan_tilausluokka,\'\')<>tl.customer_toimittajan_tilausluokka;','Tilausluokat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set customer_toimittajan_tilausluokka=tl.customer_toimittajan_tilausluokka from ui.outlets o, ui.suppliers s, ui.product_masters pm,(select supplier, outlet_code,customer_toimittajan_tilausluokka, customer_toimpakkavain from customer._tilausluokka  where outlet_code<>\'0\') tl where p.outlet_id=o.id and p.product_master_id=pm.id and p.supplier_id=s.id and tl.supplier=s.code and tl.outlet_code=o.code and tl.customer_toimpakkavain=p.customer_toimpakktunnus and p.customer_toimpakktunnus is not null  and coalesce(p.customer_toimittajan_tilausluokka,\'\')<>tl.customer_toimittajan_tilausluokka;','Lokaatiokohtaiset tilausluokat')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set customer_toimittajan_tilausluokka_nimi=customer_toimittajan_tilausluokan_nimi from (select distinct customer_toimittajan_tilausluokka, customer_toimittajan_tilausluokan_nimi from customer._tilausluokka) tl where p.customer_toimittajan_tilausluokka=tl.customer_toimittajan_tilausluokka and coalesce(customer_toimittajan_tilausluokan_nimi,\'\')<>coalesce(customer_toimittajan_tilausluokka_nimi,\'\');','Tilausluokkanimet')"
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('update ui.c_products p set customer_toimittajan_tilausluokka_nimi=customer_toimittajan_oletustilausluokan_nimi from (select distinct customer_toimittajan_oletustilausluokka, customer_toimittajan_oletustilausluokan_nimi from customer._kaytettavatoimittaja) tl where p.customer_toimittajan_tilausluokka=tl.customer_toimittajan_oletustilausluokka and coalesce(customer_toimittajan_oletustilausluokan_nimi,\'\')<>coalesce(customer_toimittajan_tilausluokka_nimi,\'\');','Oletustilausluokkanimet')"
rm /opt/capistrano/processor-sok-kt/data/messages/input/*_UTF8
/opt/capistrano/processor-sok-kt/processor_ui/current/script/runner -e production "Job.maintenance_sql('select 1', 'Loading additional product info complete')"
